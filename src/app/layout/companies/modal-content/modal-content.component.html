<div [@routerTransition]>
    <ngx-loading [show]="loading" [config]="{
          backdropBorderRadius: '3px',
          fullScreenBackdrop: false,
          primaryColour: '#222',
          secondaryColour: '#222',
          tertiaryColour: '#222'
        }"></ngx-loading>
    <div class="base-modal-content" style="min-height: 80vh">
        <div class="card-header base-modal-header flex">
            <div class="row" *ngIf="!loading">
                <div class="col text-left">
                    <i class="mdi mdi-help-circle mdi-24px" style="color:#2869D9; margin-left: 15px;"
                        (click)="help()"></i>
                </div>
                <button type="button" (click)="close()" class="close col text-right" data-dismiss="modal"
                    aria-label="Close">
                    <span id="call4" aria-hidden="true">&times;</span>
                </button>
                <br>
                <div class="col-lg-12">
                    <h2 id="call1">Dados da Empresa</h2>
                </div>

                <br />
                <div style="margin-bottom: 10px" id="call2">
                    <app-buttons-custom *ngIf="!isNew" [id]="comp._id" (edit)="editDepartament()"
                        (delete)="open('focusFirst', comp._id)" [permissionEdit]="permissionEdit"
                        [permissionDelete]="permissionDelete"></app-buttons-custom>
                </div>
            </div>


        </div>

        <div class="card-body base-modal-body">
            <ngb-tabset #tab="ngbTabset">
                <ngb-tab title="Dados da Empresa" [id]="0">
                    <ng-template ngbTabContent>
                        <form [formGroup]="companyForm" role="FormGroup" (ngSubmit)="submit()" class="form">
                            <div class="form-content" id="call3">

                                <div class="form-group  col-xl-12">
                                    <label for="input-name">Nome</label>
                                    <input type="text" oninput="this.value = this.value.toUpperCase()"
                                        placeholder="Nome da Empresa"
                                        [ngClass]="{ 'is-invalid': name.invalid && name.touched }" class="form-control"
                                        formControlName="name" />
                                    <div *ngIf="name.invalid && (name.dirty || name.touched)" class="invalid-feedback">
                                        <div *ngIf="!name.valid">
                                            Nome é obrigatório.
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group col-xl-12">
                                    <label for="adress">Endereço</label>
                                    <input id="adress" oninput="this.value = this.value.toUpperCase()"
                                        placeholder="Endereço" type="text" class="form-control" formControlName="adress"
                                        [ngClass]="{ 'is-invalid': !adress.valid && !adress.disabled }" />
                                    <div *ngIf="adress.invalid && (adress.dirty || adress.touched)"
                                        class="invalid-feedback">
                                        <div *ngIf="!adress.valid">
                                            Endereço é obrigatório.
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group col-lg-6">
                                    <label for="">Cidade</label>
                                    <input type="text" oninput="this.value = this.value.toUpperCase()"
                                        placeholder="Cidade" class="form-control" formControlName="city"
                                        [ngClass]="{ 'is-invalid': !city.valid && !city.disabled }" />
                                    <div *ngIf="city.invalid && (city.dirty || city.touched)" class="invalid-feedback">
                                        <div *ngIf="!city.valid">
                                            Cidade é obrigatória.
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group col-lg-6">
                                    <label for="province">Estado</label>
                                    <input id="province" oninput="this.value = this.value.toUpperCase()" type="text"
                                        placeholder="Estado" class="form-control" formControlName="province"
                                        [ngClass]="{ 'is-invalid': !province.valid && !province.disabled }" />
                                    <div *ngIf="province.invalid && (province.dirty || province.touched)"
                                        class="invalid-feedback">
                                        <div *ngIf="!province.valid">
                                            Estado é obrigatório.
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group col-lg-8">
                                    <label for="">E-mail</label>
                                    <input type="text" placeholder="E-mail" class="form-control" formControlName="email"
                                        [ngClass]="{ 'is-invalid': !email.valid && !email.disabled }" />
                                    <div *ngIf="email.invalid && (email.dirty || email.touched)"
                                        class="invalid-feedback">
                                        <div *ngIf="!email.valid">
                                            E-mail é obrigatório.
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group col-lg-4">
                                    <label for="">Telefone</label>
                                    <input type="text" placeholder="Telefone" class="form-control"
                                        formControlName="fone"
                                        [ngClass]="{ 'is-invalid': !fone.valid && !fone.disabled }"
                                        [textMask]="{ mask: mask.fone }" />
                                    <div *ngIf="fone.invalid && (fone.dirty || fone.touched)" class="invalid-feedback">
                                        <div *ngIf="!fone.valid">
                                            Telefone é obrigatório.
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group col-lg-12">
                                    <label for="">Responsável</label>
                                    <input type="text" placeholder="Responsável" class="form-control"
                                        formControlName="answerable"
                                        [ngClass]="{ 'is-invalid': !answerable.valid && !answerable.disabled }" />
                                    <div *ngIf="answerable.invalid && (answerable.dirty || answerable.touched)"
                                        class="invalid-feedback">
                                        <div *ngIf="!answerable.valid">
                                            Responsável é obrigatório.
                                        </div>
                                    </div>
                                </div>

                                <div
                                    [ngClass]="(hiddenCNPJ && hiddenCPF) ? 'form-group col-lg-12' : 'form-group col-lg-4'">
                                    <label for="">Tipo de Pessoa</label>
                                    <select class="form-control" id="personType" formControlName="typePerson"
                                        [ngClass]="{ 'is-invalid': !typePerson.valid && !typePerson.disabled }"
                                        (change)="typePersonChange()">
                                        <option *ngFor="let person of personTypeList | enumToArray" [value]="person">
                                            {{ person | translate }}</option>
                                    </select>
                                    <div *ngIf="typePerson.invalid && (typePerson.dirty || typePerson.touched)"
                                        class="invalid-feedback">
                                        <div *ngIf="!typePerson.valid">
                                            Tipo de pessoa é obrigatório.
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group col-lg-8" [hidden]="hiddenCPF">
                                    <label for="">CPF</label>
                                    <input id="cpf" type="text" placeholder="CPF" class="form-control"
                                        formControlName="cpf" [textMask]="{ mask: mask.cpf }" />
                                    <div *ngIf="cpf.invalid && (cpf.dirty || cpf.touched)" class="invalid-feedback">
                                        <div *ngIf="!cpf.valid">
                                            CPF é obrigatório.
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group col-lg-8" [hidden]="hiddenCNPJ">
                                    <label for="">CNPJ</label>
                                    <input id="cnpj" type="text" placeholder="CNPJ" class="form-control"
                                        formControlName="cnpj" [textMask]="{ mask: mask.cnpj }" />
                                    <div *ngIf="cnpj.invalid && (cnpj.dirty || cnpj.touched)" class="invalid-feedback">
                                        <div *ngIf="!cnpj.valid">
                                            CNPJ é obrigatório.
                                        </div>
                                    </div>
                                </div>

                                <ng-template #rtCompany let-r="result" let-t="company" class="custom-typeahead">
                                    <ngb-highlight [result]="r.name" [term]="t"></ngb-highlight>
                                </ng-template>
                            </div>
                        </form>
                        <div *ngIf="this.permissionCancelEdit && this.permissionCancelEdit" class="modal-footer">
                            <div class="pull-right" id="call5">
                                <button type="button" (click)="cancelEditNew()" class="btn btn-danger"
                                    style="margin-right:10px">Cancelar</button>
                                <button type="button" (click)="submit()" class="btn btn-primary" [disabled]="name.invalid || email.invalid || adress.invalid || 
                                province.invalid || city.invalid || fone.invalid || answerable.invalid 
                                || typePerson.invalid">
                                    Salvar
                                </button>
                            </div>
                        </div>
                    </ng-template>
                </ngb-tab>

                <ngb-tab title="Compra de Pacotes" [id]="1">
                    <ng-template ngbTabContent>
                        <form [formGroup]="searchForm" (ngSubmit)="setPagePackages(page)" role="FormGroup">
                            <div class="row" id="step2">
                                <div class="form-group mb-2 col-lg-7 col-sm-12">
                                    <label for="labelName">Nome do Pacote</label>
                                    <input id="labelPackage" autoFocus="true" type="text" placeholder="Nome do Pacote"
                                        class="form-control" formControlName="labelPackage" style="width: 100%"
                                        [ngClass]="{ 'is-invalid': labelPackage.invalid && labelPackage.touched }" />
                                    <div *ngIf="labelPackage.invalid && (labelPackage.dirty || labelPackage.touched)"
                                        class="invalid-feedback">
                                        <div *ngIf="!labelPackage.valid">
                                            Nome do Pacote é obrigatório.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row" id="step3">
                                <div class="form-group mb-2 col-lg-12 col-sm-12 text-center">
                                    <button type="submit" class="btn btn-primary" [disabled]="labelPackage.invalid">
                                        <i class="fa fa-search"></i>
                                    </button>
                                    <button type="submit" class="btn dark-btn" style="margin-left: 5px;"
                                        [disabled]="labelPackage.invalid" (click)="clear()">
                                        Limpar Campos
                                    </button>
                                </div>
                            </div>
                        </form>
                        <div>
                            <ngx-datatable #myTable class="bootstrap" [rows]="packages.items"
                                [columnMode]="ColumnMode.force" [scrollbarH]="true" [headerHeight]="50"
                                [footerHeight]="50" rowHeight="auto" [externalPaging]="true"
                                [count]="page.totalElements" [offset]="page.pageNumber" [limit]="10"
                                (page)='setPagePackages($event)'>
                                <ngx-datatable-column name="Nome do Pacote" prop="labelPackage"></ngx-datatable-column>
                                <ngx-datatable-column name="Assinatura Digital" prop="signature">
                                    <ng-template let-value="value" ngx-datatable-cell-template>
                                        <ng-container *ngIf="value == true">
                                            <abbr title="Possui assinatura digital">
                                                <i class="mdi mdi-draw-pen mdi-24px"></i>
                                            </abbr>
                                        </ng-container>
                                    </ng-template>
                                </ngx-datatable-column>
                                <ngx-datatable-column name="Número de Arquivos para Assinar" prop="filesPackage">
                                </ngx-datatable-column>
                                <ngx-datatable-column name="OCR" prop="ocr">
                                    <ng-template let-value="value" ngx-datatable-cell-template>
                                        <ng-container *ngIf="value === true">
                                            <abbr title="Possui OCR">
                                                <i class="mdi mdi-ocr mdi-24px"></i>
                                            </abbr>
                                        </ng-container>
                                    </ng-template>
                                </ngx-datatable-column>
                                <ngx-datatable-column name="Número de páginas OCR" prop="pagesPackage">
                                </ngx-datatable-column>
                                <ngx-datatable-column name="Valor" prop="price">
                                    <ng-template let-value="value" ngx-datatable-cell-template>
                                        {{value | currency:'BRL':true:'1.2-2' }}
                                    </ng-template>
                                </ngx-datatable-column>
                                <ngx-datatable-column name="" prop="_id">
                                    <ng-template let-value="value" ngx-datatable-cell-template>
                                        <button class="btn btn-success" (click)="buyPackage(value); tab.select('tab3')">Comprar</button>
                                    </ng-template>
                                </ngx-datatable-column>
                            </ngx-datatable>
                        </div>
                    </ng-template>
                </ngb-tab>

                <ngb-tab title="Configurações" id="tab3">
                    <ng-template ngbTabContent>

                    </ng-template>
                </ngb-tab>
            </ngb-tabset>

        </div>
    </div>
</div>