<div [@routerTransition]>
  <ngx-loading [show]="loading" [config]="{
          backdropBorderRadius: '3px',
          fullScreenBackdrop: true,
          primaryColour: '#222',
          secondaryColour: '#222',
          tertiaryColour: '#222'
      }"></ngx-loading>
  <app-page-header [heading]="'Movimentação'" [icon]="'fa-user'"></app-page-header>
  <div style="margin-bottom: 10px">
    <app-button-back [redirectTo]="'moviments'"></app-button-back>
    <app-buttons-custom *ngIf="moviment" [id]="moviment._id" (edit)="editMoviment(moviment._id)"
      (delete)="open('focusFirst', moviment._id)" [permissionEdit]="false"
      [permissionDelete]="permissionDelete && !processed"></app-buttons-custom>
    <br />
  </div>
  <div class="card bg-light mb-12">
    <div class="card-body">
      <ngb-tabset #tab *ngIf="moviment">
        <ngb-tab title="Movimentação Nr {{moviment.nr}}" id="tab1">
          <ng-template ngbTabContent>
            <br />
            <form [formGroup]="movimentForm" role="FormGroup">
              <div class="form-row">
                <div class="form-group col">
                  <label for="typeahead-basic">Empresa</label>
                  <input id="typeahead-basic" type="text" class="form-control" formControlName="company"
                    [resultTemplate]="rtCompany" [inputFormatter]="formatter" [ngbTypeahead]="searchCompany"
                    [ngClass]="{ 'is-invalid': !companyIpt.valid && !companyIpt.disabled }" />
                  <div *ngIf="companyIpt.invalid && (companyIpt.dirty || companyIpt.touched)" class="invalid-feedback">
                    <div *ngIf="!companyIpt.valid">
                      Empresa é obrigatória.
                    </div>
                  </div>
                </div>
                <div class="form-group col">
                  <label for="">Nome do Solicitante</label>
                  <input type="text" class="form-control" formControlName="requester">
                </div>
                <ng-template #rtCompany let-r="result" let-t="company" class="custom-typeahead">
                  <ngb-highlight [result]="r.name" [term]="t"></ngb-highlight>
                </ng-template>
              </div>
              <div class="form-row">
                <div class="form-group col">
                  <label for="">Natureza da Movimentação</label>
                  <input type="text" class="form-control" *ngIf="moviment && moviment.loan" formControlName="loan">
                  <input type="text" class="form-control" *ngIf="moviment && moviment.low" formControlName="low">
                </div>
                <div class="form-group col">
                  <label for="">Tipo da Movimentação</label>
                  <input type="text" *ngIf="moviment && moviment.moveVolume" class="form-control"
                    formControlName="moveVolume">
                  <input type="text" *ngIf="moviment && moviment.moveArchive" class="form-control"
                    formControlName="moveArchive">
                </div>
                <div class="form-group col">
                  <label for="">Prazo</label>
                  <input type="text" class="form-control" *ngIf="moviment && moviment.normal" formControlName="normal">
                  <input type="text" class="form-control" *ngIf="moviment && moviment.emergency"
                    formControlName="emergency">
                </div>
                <div class="form-group col">
                  <label for="">Formato da Entrega</label>
                  <input type="text" class="form-control" *ngIf="moviment && moviment.delivery"
                    formControlName="delivery">
                  <input type="text" class="form-control" *ngIf="moviment && moviment.withdraw"
                    formControlName="withdraw">
                  <input type="text" class="form-control" *ngIf="moviment && moviment.digital"
                    formControlName="digital">
                </div>
              </div>
              <button class="btn btn-primary pull-right" [routerLink]="['/moviments/searchvolumes', moviment._id]"
                *ngIf="moviment && moviment.moveVolume ">Pesquisar Caixas</button>
              <button class="btn btn-primary pull-right" [routerLink]="['/moviments/searcharchives', moviment._id]"
                *ngIf="moviment &&  moviment.moveArchive">Pesquisar Arquivos</button>
            </form>
          </ng-template>
        </ngb-tab>
        <ngb-tab id="tab2" title="Ver Arquivos" *ngIf="moviment.moveArchive">
          <ng-template ngbTabContent>
            <br>
            <form [formGroup]="archiveForm" role="FormGroup" (ngSubmit)="searchItensArchives()">
              <div class="form-row">
                <div class="form-group col">
                  <label for="typeahead-basic">Documento</label>
                  <input id="typeahead-basic" type="text" class="form-control" formControlName="document"
                    [resultTemplate]="rtDocument" [inputFormatter]="formatter" [ngbTypeahead]="searchDocument" />
                </div>
                <div class="form-group col">
                  <label for="typeahead-basic">Depósito</label>
                  <input id="typeahead-basic" type="text" class="form-control" formControlName="storehouse"
                    [resultTemplate]="rtStorehouse" [inputFormatter]="formatter" [ngbTypeahead]="searchStorehouse" />
                </div>
                <div class="form-group col">
                  <label for="location">Posição</label>
                  <input type="text" class="form-control" formControlName="location" />
                </div>
                <div class="form-group col">
                  <label for="search">Índice</label>
                  <input type="text" class="form-control" formControlName="search" />
                </div>
              </div>
              <div class="form-row" style="display: flex;justify-content: center;">
                <button type="submit" class="btn btn-primary">
                  <i class="fa fa-search"></i>
                </button>
                <button class="btn btn-danger" (click)="remove()">Remover</button>
              </div>
              <ng-template #rtStorehouse let-r="result" let-t="storehouse" class="custom-typeahead">
                <ngb-highlight [result]="r.name" [term]="t"></ngb-highlight>
              </ng-template>
              <ng-template #rtDocument let-r="result" let-t="document" class="custom-typeahead">
                <ngb-highlight [result]="r.name" [term]="t"></ngb-highlight>
              </ng-template>
            </form>
            <div class="row" *ngIf="archives && archives.items.length > 0">
              <div class="col col-xl-12 col-lg-12">
                <ngx-datatable class="material striped" [rows]="archives.items" [columnMode]="'force'"
                  [headerHeight]="50" [footerHeight]="50" [rowHeight]="'auto'" [externalPaging]="true"
                  [count]="page.totalElements" [offset]="page.pageNumber - 1" [limit]="page.size"
                  (page)="searchItensArchives($event)" [selected]="selected" [selectionType]="'checkbox'"
                  [selectAllRowsOnPage]="false" (select)="onSelect($event)">
                  <ngx-datatable-column [width]="30" [sortable]="false" [canAutoResize]="false" [draggable]="false"
                    [resizeable]="false" [headerCheckboxable]="true" [checkboxable]="true">
                    <ng-template ngx-datatable-header-template let-value="value" let-allRowsSelected="allRowsSelected"
                      let-selectFn="selectFn">
                      <input type="checkbox" [checked]="allRowsSelected" (change)="selectFn(!allRowsSelected)" />
                    </ng-template>
                  </ngx-datatable-column>
                  <ngx-datatable-column name="Departamento" prop="departament.name"></ngx-datatable-column>
                  <ngx-datatable-column name="Depósito" prop="storehouse.name"></ngx-datatable-column>
                  <ngx-datatable-column name="Posição" prop="location"></ngx-datatable-column>
                  <ngx-datatable-column name="Indexação" prop="tag"></ngx-datatable-column>
                </ngx-datatable>
              </div>
            </div>
          </ng-template>
        </ngb-tab>
        <ngb-tab id="tab3" title="Ver Volumes" *ngIf="moviment.moveVolume" (click)="showItensVolumes()">
          <ng-template ngbTabContent>
            <br>
            <form [formGroup]="volumeForm" role="FormGroup" (ngSubmit)="showItensVolumes()">
              <div class="form-row">
                <div class="form-group col">
                  <label for="typeahead-basic">Departamento</label>
                  <input id="typeahead-basic" type="text" class="form-control" formControlName="departament"
                    [resultTemplate]="rtDepartament" [inputFormatter]="formatter" [ngbTypeahead]="searchDepartament" />
                </div>
                <ng-template #rtDepartament let-r="result" let-t="departament" class="custom-typeahead">
                  <ngb-highlight [result]="r.name" [term]="t"></ngb-highlight>
                </ng-template>
                <div class="form-group col">
                  <label for="location">Posição</label>
                  <input type="text" class="form-control" formControlName="location" />
                </div>
                <div class="form-group col">
                  <label for="typeahead-basic">Depósito</label>
                  <input id="typeahead-basic" type="text" class="form-control" formControlName="storehouse"
                    [resultTemplate]="rtStorehouse" [inputFormatter]="formatter" [ngbTypeahead]="searchStorehouse" />
                </div>
                <ng-template #rtStorehouse let-r="result" let-t="storehouse" class="custom-typeahead">
                  <ngb-highlight [result]="r.name" [term]="t"></ngb-highlight>
                </ng-template>
                <div class="form-group col">
                  <label for="reference">Referência</label>
                  <input type="text" class="form-control" formControlName="reference" />
                </div>
              </div>
              <div class="form-row" style="display: flex;justify-content: center;">
                <button type="submit" class="btn btn-primary">
                  <i class="fa fa-search"></i>
                </button>
                <button class="btn btn-danger" (click)="removeVolumes()">Remover</button>
              </div>
            </form>
            <div class="row" *ngIf="volumes && volumes.items.length > 0">
              <div class="col col-xl-12 col-lg-12">
                <ngx-datatable class="material striped" [rows]="volumes.items" [columnMode]="'force'"
                  [headerHeight]="50" [footerHeight]="50" [rowHeight]="'auto'" [externalPaging]="true"
                  [count]="pageVolumes.totalElements" [offset]="pageVolumes.pageNumber - 1" [limit]="pageVolumes.size"
                  (page)="showItensVolumes($event)" [selected]="selectedVolumes" [selectionType]="'checkbox'"
                  [selectAllRowsOnPage]="false" (select)="onSelectVolumes($event)">
                  <ngx-datatable-column [width]="30" [sortable]="false" [canAutoResize]="false" [draggable]="false"
                    [resizeable]="false" [headerCheckboxable]="true" [checkboxable]="true">
                    <ng-template ngx-datatable-header-template let-value="value" let-allRowsSelected="allRowsSelected"
                      let-selectFn="selectFn">
                      <input type="checkbox" [checked]="allRowsSelected" (change)="selectFn(!allRowsSelected)" />
                    </ng-template>
                  </ngx-datatable-column>
                  <ngx-datatable-column name="Departamento" prop="departament.name"></ngx-datatable-column>
                  <ngx-datatable-column name="Depósito" prop="storehouse.name"></ngx-datatable-column>
                  <ngx-datatable-column name="Posição" prop="location"></ngx-datatable-column>
                  <ngx-datatable-column name="Referência" prop="reference"></ngx-datatable-column>
                  <!-- <ngx-datatable-column name="Tipo de Guarda" prop="guardType"></ngx-datatable-column> -->
                  <ngx-datatable-column name="Criado em" prop="dateCreated">
                    <ng-template let-value="value" ngx-datatable-cell-template>
                      {{ value | date: 'dd/MM/yyyy' }}
                    </ng-template>
                  </ngx-datatable-column>
                  <!-- <ngx-datatable-column name="Suspensa" prop="indDemand">
                    <ng-template let-value="value" ngx-datatable-cell-template>
                      {{ value ? 'Sim' : 'Não' }}
                    </ng-template>
                  </ngx-datatable-column> -->
                </ngx-datatable>
              </div>
            </div>
          </ng-template>
        </ngb-tab>
        <ngb-tab id="tab4" title="Processar Movimentação">
          <ng-template ngbTabContent>
          </ng-template>
        </ngb-tab>
      </ngb-tabset>
    </div>
  </div>
</div>